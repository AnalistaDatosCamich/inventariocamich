
<!DOCTYPE html>
<html>
<head>
    <title>Administrar Inventario</title>
    <link rel="stylesheet" href="../static/style.css">
    <link rel="shortcut icon" href="../static/CamichLogo.ico">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

</head>
<body>
<div id="container">
    <h1>Panel de Administración</h1>
    <h2>{{ 'Editar' if item else 'Agregar' }} Item</h2>
    <div class="admin-form">
        <form method="POST" enctype="multipart/form-data">
            {% if item %}<input type="hidden" name="id" value="{{ item[0] }}">{% endif %}
      
            <p>Prefijo: 
            <select name="prefijo" required {{ 'disabled' if item else '' }}>
                <option value="">-- Selecciona un prefijo --</option>
                {% for prefijo in prefijos %}
                <option value="{{ prefijo[0] }}" {{ 'selected' if item and item[1].startswith(prefijo[0]) else '' }}>
                    {{ prefijo[0] }} ({{ prefijo[1] }})
                </option>
                {% endfor %}
            </select>
            <a href="{{ url_for('admin_prefijos') }}" class="input-btn" id="admin-prefix" style="text-decoration: none; display: inline-block; text-align: center; margin-left: 10px;">Administrar Prefijos</a>
            {% if item %}<small>Código actual:<code> {{ item[1] }}</code></small>{% endif %}
            </p>  
            <p>Descripción: <input type="text" name="descripcion" value="{{ item[2] if item else '' }}"></p>
            <p>Identificador: <input type="text" name="identificador" value="{{ item[3] if item else '' }}"></p>
            <p>Usuario: <input type="text" name="usuario" value="{{ item[4] if item else '' }}"></p>
            <p>Departamento: <input type="text" name="departamento" value="{{ item[5] if item else '' }}"></p>
            <div class="note-group">
                <label for="notas">Notas:</label>
                <textarea rows="8" cols="50" maxlength="500" name="notas" placeholder="Escribe aquí notas y detalles adicionales del item">{{ item[6] if item }} </textarea>
            </div>
            <p>Foto: <input type="file" name="foto" accept="image/*">

            {% if item and item[7] and item[7] != "camich.png" %}
                <br><small>Imagen actual:</small><br>
                <img src="{{ url_for('static', filename='images/' + item[7]) }}" width="100">
                <br><a href="{{ url_for('delete_image', item_id=item[0]) }}" 
                    onclick="return confirm('¿Seguro que quieres eliminar esta imagen?')" 
                    class="input-btn" >
                    Borrar imagen
                </a>
            {% endif %}
            </p>

            <input class="input-btn" type="submit" value="{{ 'Guardar' if item else 'Agregar' }}">
            {% if item %}
                <input class="input-btn" type="submit" value="Cancelar">
            {% endif %}
        </form>
        <div id="back-to-index"><a href="{{ url_for('index') }}">← Volver al inventario</a></div>
    </div>

    <h2>Artículos existentes</h2>
    <table id="items-table">
    <thead>
        <tr>
            <th>Código</th>
            <th>Descripción</th>
            <th>Usuario</th>
            <th>Departamento</th>
            <th>Foto</th>
            <th>Editar</th>
            <th>Eliminar</th>
        </tr>
        <tr>
            <th><input type="text" placeholder="Buscar código"></th>
            <th><input type="text" placeholder="Buscar descripción"></th>
            <th><input type="text" placeholder="Buscar usuario"></th>
            <th><input type="text" placeholder="Buscar departamento"></th>
            <th></th>
            <th></th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% for item in items %}
        <tr>
            <td>{{ item[1] }}</td> <!-- código -->
            <td>{{ item[2] }}</td> <!-- descripción -->
            <td>{{ item[4] }}</td> <!-- usuario -->
            <td>{{ item[5] }}</td> <!-- departamento -->
            <td><img src="{{ url_for('static', filename='images/' + ((item[7]) or 'camich.png')) }}" width="50"></td>
            <td><a href="{{ url_for('admin', id=item[0]) }}">Editar</a></td>
            <td><a href="{{ url_for('delete', item_id=item[0]) }}" onclick="return confirm('¿Seguro que quieres eliminar este elemento?')">Eliminar</a></td>
        </tr>
        {% endfor %}
    </tbody>
    </table>
</div>

<script>
// Formateo inteligente para nombres propios
function formatearTexto(texto) {
    if (!texto) return '';
    
    // Lista de palabras que deben ir en minúsculas (preposiciones, artículos, etc.)
    const minusculas = ['de', 'del', 'la', 'el', 'los', 'las', 'y', 'e', 'o', 'u', 'en', 'con', 'por', 'para'];
    
    return texto.toLowerCase().split(' ').map((palabra, index) => {
        // Primera palabra siempre con mayúscula
        if (index === 0) {
            return palabra.charAt(0).toUpperCase() + palabra.slice(1);
        }
        
        // Si está en la lista de minúsculas, mantener en minúscula
        if (minusculas.includes(palabra)) {
            return palabra;
        }
        
        // Resto de palabras con primera letra mayúscula
        return palabra.charAt(0).toUpperCase() + palabra.slice(1);
    }).join(' ');
}

// Aplicar formato al enviar el formulario
document.querySelector('form').addEventListener('submit', function() {
    const campos = ['descripcion', 'usuario', 'departamento'];
    
    campos.forEach(campo => {
        const input = document.querySelector(`input[name="${campo}"]`);
        if (input && input.value) {
            input.value = formatearTexto(input.value.trim());
        }
    });
    
});
</script>

</body>

<script>
$(document).ready(function () {
    var table = $('#items-table').DataTable({
        language: {
            "search": "Buscar:",
            "lengthMenu": "Mostrar _MENU_ registros por página",
            "zeroRecords": "No se encontraron resultados",
            "info": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
            "infoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
            "infoFiltered": "(filtrado de un total de _MAX_ registros)",
            "paginate": {
                "first": "Primero",
                "last": "Último",
                "next": "Siguiente",
                "previous": "Anterior"
            }
        }
    });
    
    $('#items-table thead tr:eq(1) th').each(function (i) {
        $('input', this).on('keyup change', function () {
            if (table.column(i).search() !== this.value) {
                table.column(i).search(this.value).draw();
            }
        });
    });
});
</script>

</html>
